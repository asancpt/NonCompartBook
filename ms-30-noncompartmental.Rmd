---
output: html_document
editor_options: 
  chunk_output_type: console
---

# R을 사용한 비구획분석 {#noncompart}

## 이 장에서는 {#summary-noncompart}

`NonCompart` [@R-NonCompart],  `ncar` [@R-ncar] 은 비구획 분석을 R을 통해 쉽고 빠르게 (매우 빠르게) 행할 수 있는 패키지입니다. 
`NonCompart`의 제목은 `r packageDescription("NonCompart")$Title`이고, `ncar`의 제목은 `r packageDescription("ncar")$Title`입니다.
이에 대해 알아보겠습니다.

## 데이타에 대해 {#TheophData}

R에는 theophylline과 Indomethacin의 약동학 데이터가 내장되어 있습니다.

- `Theoph`: theophylline의 약동학 데이터, 12명, 320mg PO 단회투여, 0~24시간 채혈, NONMEM 의 run 폴더의 THEOPP 데이터와 동일합니다.
- `Indometh`: Indomethacin의 약동학 데이터, 6명, 25mg IV bolus 단회투여, 0~8시간 채혈(0, 0.25, 0.5, 0.75, 1, 1.25, 2, 3, 4, 5, 6, 8 h)
(데이터명의 첫글짜가 대문자임에 주의하길)

먼저 데이터를 살펴보겠습니다. 

```{r}
head(Theoph)
tail(Theoph)
```

다음과 같이 테스트 할 수 있습니다.

```{r}
TheophNca <- tblNCA(Theoph, key="Subject", dose=320, concUnit="mg/L")
```

이는 문자(character)로 구성된 matrix로 구성된 결과물과 단위 정보가 담긴 attribute를 포함하고 있습니다.

데이터가 Subject, weight, Dose, Time, Concentration 으로 구성되었음을 알 수 있습니다.

```{r TheophFig, fig.width=8, fig.height=12, fig.cap='Theoph 데이타를 시각화. A) Individual concentration-time curves, B) linear concentration-time curves, C) semi-logarithmic concentration-time curves'}
Backbone <- ggplot(Theoph %>% 
                       mutate(Subject = as.numeric(Subject)), 
                   aes(Time, conc, group = Subject, colour = Wt)) +
    geom_line() +
    geom_point() 

Individual <- Backbone + facet_wrap(~ Subject) + scale_y_log10()
groupLinear <- Backbone
groupLog <- groupLinear + scale_y_log10()

ggdraw() +
    draw_plot(Individual, 0, .5, 1, .5) +
    draw_plot(groupLinear, 0, 0, .5, .5) +
    draw_plot(groupLog, .5, 0, .5, .5) +
    draw_plot_label(c("A", "B", "C"), c(0, 0, 0.5), c(1, 0.5, 0.5), size = 15)
```

이 패키지로 NCA 비구획방법으로 약동학 파라미터를 산출하기 위해서는 아래와 같이 하면 됩니다.
우선 Theophilline 의 약동학 파라미터를 구해보면,

```{r}
NonCompart::tblNCA(Theoph, "Subject", "Time", "conc", dose=320)
```

다음으로 Indomethacin 의 약동학 파라미터를 구해보자. 이는 IV bolus 이므로 AdmMode 옵션이 추가된다.

```{r}
NonCompart::tblNCA(Indometh, "Subject", "time", "conc", dose=25, adm="Bolus", dur=0.5, concUnit="mg/L")
```

## NonCompart 사용법

NCA의 사용법은 다음과 같습니다.

`NCA(Data, colSubj, colTime, colConc, colTrt, Method = "Linear", Dose = 0, AdmMode = "Extravascular", TimeInfusion = 0, Report = "Table", iAUC)`

Data는 데이터셋을 설정하며, colSubj는 subject ID의 컬럼명, colTime은 time의 컬럼명, colConc는 concentration의 컬럼명, colTrT는 treatment code의 컬럼명(교차시험에서 사용)이다.

```{r, eval = FALSE}
tblNCA(concData, colSubj = "Subject", colTime = "Time", colConc = "conc", dose = 0, 
       adm = "Extravascular", dur = 0, doseUnit = "mg", timeUnit = "h", 
       concUnit = "ug/L", down = "Linear", MW = 0, returnNA = FALSE)
```

```{r, eval = FALSE, include = FALSE}
tblNCA(concData, key = "Subject", colTime = "Time", colConc = "conc", dose = 0, 
       adm = "Extravascular", dur = 0, doseUnit = "mg", timeUnit = "h", 
       concUnit = "ug/L", down = "Linear", MW = 0)
```

```{r}
args(NonCompart::tblNCA)
```

```{r, include = FALSE, evel = FALSE}
NonCompartdb <- tools::Rd_db('NonCompart')
tblNcaExample <- sapply(NonCompartdb, tools:::.Rd_get_metadata, 'usage')$tblNCA.Rd %>% .[-1]
paste(tblNcaExample, collapse = '\\n')
```

NCA의 옵션들에 대해서 간단히 살펴보자면 다음과 같습니다. 

1. Method
    - AUC와 AUMC를 구하는 trapezoidal method 설정, 기본값은 Method="Linear"
    - Linear와 Log 중 선택 가능하다.
    - Linear는 Linear trapezoidal method이며, Log는 Linear-up and log-down method 입니다.
2. Dose
    - 투여량에 대한 설정이다. 단위에 주의해야 한다. 벡터값을 줌으로서 각 대상자별 용량을 다르게 할 수 있습니다.
3. AdmMode
    - 투여경로에 대한 설정, 기본값은 AdmMode= "Extravascular" 
    - Bolus, Infusion, Extravascular 중에서 선택 가능하다.
4. TimeInfusion
    - 주입하는 기간(infusion duration)을 설정한다. 기본값은 0이다.
5. iAUC
    - 일부구간에 대한 AUC를 구하기 위한 구간설정 옵션입니다.
    - "Name", "Start", "End" 3개의 컬럼으로 구성된 데이터 프레임으로 설정해야 합니다.

일부 구간의 AUC를 구하는 방법은 조금 더 복잡하므로 자세히 알아보자.
예를 들어 0~12시간까지의 AUC, 0~24시간까지의 AUC를 구하고자 한다면 다음과 같이 하면 된다.
먼저 구하고자 하는 구간에 대한 정보를 갖는 변수를 아래와같이 생성한다.

```{r}
iAUC = data.frame(Name=c("AUC[0-12h]","AUC[0-24h]"), Start=c(0,0), End=c(12,24)) ; iAUC
```
        Name Start End
1 AUC[0-12h]     0  12
2 AUC[0-24h]     0  24

이제 iAUC 옵션을 이용해서 이를 구한다.

```{r}
# tblNCA(Theoph, "Subject", "Time", "conc", dose=320, iAUC=iAUC)
```

맨 마지막 파라미터로 AUC[0-12h], AUC[0-24h]가 추가되었음을 알 수 있다.

## 함수 살펴보기

NonCompart 패키지 내의 여러가지 함수를 살펴보겠습니다. `r paste0(paste0(ls('package:NonCompart'), '()'), collapse = ', ')`라는 함수가 있습니다.


### AUC

AUC와 AUMC를  'Linear trapezoidal method' 혹은 'linear-up and log-down method'의 두가지 방식으로 계산하게 됩니다.

```{r}
AUC(Theoph[Theoph$Subject==1, "Time"], Theoph[Theoph$Subject==1, "conc"])
AUC(Theoph[Theoph$Subject==1, "Time"], Theoph[Theoph$Subject==1, "conc"], down="Log")
```

## 긴 형식으로 변환하면서 단위 추가하기 {#long-format}

NonCompart 패키지의 tblNCA()함수를 사용해서 비구획분석 결과를 내면 문자형식의 행렬이 생성되고 그 attr로 dimnames와 units를 갖는데 이를 long format의 tidy data로 변환하는 방법은 다음과 같습니다.

```{r}
ncares <- NonCompart::tblNCA(Theoph, key="Subject", dose=320, concUnit="mg/L")
str(ncares)

left_join(as_tibble(ncares) %>% gather(PPTESTCD, PPORRES, -Subject),
          tibble(PPTESTCD = attr(ncares, 'dimnames')[[2]], UNIT = attr(ncares, 'units')),
          by = 'PPTESTCD') %>% 
  arrange(Subject, PPTESTCD) %>% 
  head(20)
```



