---
title: "R을 통한 비구획분석: 실습"
output:
  xaringan::moon_reader: 
    df_print: kable
---

```{r setup, include = FALSE}
library(tidyverse)
library(knitr)
options(knitr.table.format = 'html')
opts_chunk$set(error = TRUE, results = 'hide')
Sys.setlocale('LC_ALL','C')
```

# 목적

- 무료 통계 소프트웨어인 R을 사용하여 비구획분석을 수행할 수 있도록 안내할 것입니다.

---

# 서론

`NonCompart`, `ncar`, `pkr`

- 비구획 분석을 쉽게 해 주는 프로그램
- 널리 쓰이지만 비싼 상용 소프트웨어와 동일한 결과를 얻을 수 있음을 반복적으로 확인
- 숫자 계산 뿐만 아니라 시각화도 가능
  - 농도-시간 곡선, 용량군 별 파라메터의 forest plot 등의 유용한 그림도 쉽게 그릴 수 있습니다.
- CDISC SDTM 표준을 따르는 용어를 사용
- 속도와 연속성 
- 재현가능한 연구

---

NCA의 옵션들에 대해서 간단히 살펴보자면 다음과 같습니다. 

1. `down`
  - AUC와 AUMC를 구하는 trapezoidal method 설정, 기본값은 Method="Linear"
  - Linear와 Log 중 선택 가능.
  - Linear는 Linear trapezoidal method이며, Log는 Linear-up and log-down method 입니다.
2. `dose`
  - 투여량에 대한 설정이다. 
  - 단위에 주의해야 한다. 
  - 벡터값을 줌으로서 각 대상자별 용량을 다르게 할 수 있습니다.
3. `adm`
  - 투여경로에 대한 설정, 기본값은 "Extravascular"으로 경구 투여 등을 의미합니다.
  - Bolus, Infusion, Extravascular 중에서 선택 가능하다.
4. `dur`
  - 주입하는 기간(infusion duration)을 설정한다. 기본값은 0이다.


---



# Install

```{r eval = FALSE}
install.packages('NonCompart')
install.packages('ncar')
install.packages('pkr')
```

```{r}
library(NonCompart)
library(ncar)
library(pkr)
```

```{r}
?NonCompart
?tblNCA
```

---
class: middle, center

# How to use this?i

---

# test

```{r}
head(Theoph, n=20)
```


```{r}
ggplot(Theoph, aes(Time, conc, group = Subject, color = Subject)) +
  geom_point(size = 4) + geom_line(size = 1) +
  theme_minimal() +
  labs(title = 'Theoph 경구 복용 후 시간-농도 그래프',
       x = '시간', y = '농도')
```


```{r}
# For one subject
x = Theoph[Theoph$Subject=="1","Time"]
y = Theoph[Theoph$Subject=="1","conc"]

sNCA(x, y, dose=320, doseUnit="mg", concUnit="mg/L", timeUnit="h")
```



```{r}
ggplot(Theoph %>% filter(Subject == 1), aes(Time, conc, group = Subject, color = Subject)) +
  geom_point(size = 4) + geom_line(size = 1) +
  theme_minimal() +
  labs(title = 'Theoph 경구 복용 후 시간-농도 그래프 (Subject 1)',
       x = '시간', y = '농도')
```


# tblNCA()

아래의 코드를 R의 콘솔창에 넣어보세요.

```{r eval = FALSE}

tblNCA(Theoph, key="Subject", dose=320, concUnit="mg/L")

```

```{r}
as_tibble(results_nca)
```

---


# ncar

```{r}

?ncar::txtNCA()


ncar::RptCfg
```

```{r}

txtNCA(Theoph[Theoph$Subject=="1","Time"], Theoph[Theoph$Subject=="1","conc"], 
       dose=320, doseUnit="mg", concUnit="mg/L", timeUnit="h")


writeLines(txtNCA(Theoph[Theoph$Subject=="1","Time"], Theoph[Theoph$Subject=="1","conc"], 
       dose=320, doseUnit="mg", concUnit="mg/L", timeUnit="h"), 'text.txt')
```


```{r pdfNCA}

pdfNCA(fileName="NCA-Theoph.pdf", Theoph, colSubj="Subject", colTime="Time", 
       colConc="conc", dose=320, doseUnit="mg", timeUnit="h", concUnit="mg/L")

```



---

## 데이타에 대해 {#TheophData}

(데이터명의 첫글짜가 대문자임에 주의하길)

---

다음과 같이 테스트 할 수 있습니다.

```{r}
TheophNca <- tblNCA(Theoph, key="Subject", dose=320, concUnit="mg/L")
head(TheophNca)
```

이는 문자(character)로 구성된 matrix로 구성된 결과물과 단위 정보가 담긴 attribute를 포함하고 있습니다.

데이터가 Subject, weight, Dose, Time, Concentration 으로 구성되었음을 알 수 있습니다.

```{r TheophFig, include = FALSE, fig.width=8, fig.height=12, fig.cap='Theoph 데이타를 시각화. A) Individual concentration-time curves, B) linear concentration-time curves, C) semi-logarithmic concentration-time curves'}
Backbone <- ggplot(Theoph %>% 
                     mutate(Subject = as.numeric(Subject)), 
                   aes(Time, conc, group = Subject, colour = Wt)) +
  geom_line() +
  geom_point() 

Individual <- Backbone + facet_wrap(~ Subject) + scale_y_log10()
groupLinear <- Backbone
groupLog <- groupLinear + scale_y_log10()
```

---

# 한명에 대한 간단한 비구획 분석

```{r}
iAUC <- data.frame(Name=c("AUC[0-12h]","AUC[0-24h]"), Start=c(0,0), End=c(12,24)) ; iAUC
sNCA(x, y, dose=320, concUnit="mg/L", iAUC=iAUC)
```




---

## Theoph 비구획분석

이 패키지로 NCA 비구획방법으로 약동학 파라미터를 산출하기 위해서는 아래와 같이 하면 됩니다.
우선 Theophilline 의 약동학 파라미터를 구해보겠습니다.

```{r}
tblNCA(Theoph, "Subject", "Time", 
       "conc", dose=320)
```

---

## Indometh 비구획분석

다음으로 Indomethacin 의 약동학 파라미터를 구해보자. 이는 IV bolus 이므로 AdmMode 옵션이 추가됩니다.

```{r}
tblNCA(Indometh, "Subject", "time", "conc", 
       dose=25, adm="Bolus", dur=0.5, concUnit="mg/L")
```


## NonCompart 사용법 {#how-to-use}

NCA의 사용법은 다음과 같습니다.

`NCA(Data, colSubj, colTime, colConc, colTrt, Method = "Linear", Dose = 0, AdmMode = "Extravascular", TimeInfusion = 0, Report = "Table", iAUC)`

Data는 데이터셋을 설정하며, colSubj는 subject ID의 컬럼명, colTime은 time의 컬럼명, colConc는 concentration의 컬럼명, colTrT는 treatment code의 컬럼명(교차시험에서 사용)이다.

```r
tblNCA(concData, key = "Subject", colTime = "Time", colConc = "conc", 
       dose = 0, adm = "Extravascular", dur = 0, doseUnit = "mg", 
       timeUnit = "h", concUnit = "ug/L", down = "Linear", MW = 0)
# args(NonCompart::tblNCA)
```

```{r, include = FALSE, evel = FALSE}
NonCompartdb <- tools::Rd_db('NonCompart')
tblNcaExample <- sapply(NonCompartdb, tools:::.Rd_get_metadata, 'usage')$tblNCA.Rd %>% .[-1]
paste(tblNcaExample, collapse = '\\n')
```


## 구간 NCA {#interval-NCA}

1. iAUC
    - 일부구간에 대한 AUC를 구하기 위한 구간설정 옵션입니다.
    - "Name", "Start", "End" 3개의 컬럼으로 구성된 데이터 프레임으로 설정해야 합니다.

일부 구간의 AUC를 구하는 방법은 조금 더 복잡하므로 자세히 알아봅시다.
예를 들어 0~12시간까지의 AUC, 0~24시간까지의 AUC를 구하고자 한다면 다음과 같이 하면 됩니다.
먼저 구하고자 하는 구간에 대한 정보를 갖는 변수를 아래와같이 생성합니다.

```{r}
iAUC <- data.frame(Name=c("AUC[0-12h]","AUC[0-24h]"), Start=c(0,0), End=c(12,24)) ; iAUC
```
        Name Start End
1 AUC[0-12h]     0  12
2 AUC[0-24h]     0  24

이제 iAUC 옵션을 이용해서 이를 구합니다.

```{r}
# tblNCA(Theoph, "Subject", "Time", "conc", dose=320, iAUC=iAUC)
```

맨 마지막 파라미터로 AUC[0-12h], AUC[0-24h]가 추가되었음을 알 수 있습니다.

## 함수 살펴보기 {#functions}

NonCompart 패키지 내의 여러가지 함수를 살펴보겠습니다. `r paste0(paste0(ls('package:NonCompart'), '()'), collapse = ', ')`라는 함수가 있습니다.

### AUC

AUC와 AUMC를  'Linear trapezoidal method' 혹은 'linear-up and log-down method'의 두가지 방식으로 계산하게 됩니다.

```{r}
AUC(Theoph[Theoph$Subject==1, "Time"], Theoph[Theoph$Subject==1, "conc"])
AUC(Theoph[Theoph$Subject==1, "Time"], Theoph[Theoph$Subject==1, "conc"], down="Log")
```

