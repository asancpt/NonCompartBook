---
output: html_document
editor_options: 
  chunk_output_type: console
---

# R을 사용한 비구획분석 {#noncompart}

## 이 장에서는 {#summary-noncompart}

`NonCompart` [@R-NonCompart],  `ncar` [@R-ncar] 은 비구획 분석을 R을 통해 쉽고 빠르게 (매우 빠르게) 행할 수 있는 패키지입니다. 
`NonCompart`의 제목은 `r packageDescription("NonCompart")$Title`이고, `ncar`의 제목은 `r packageDescription("ncar")$Title`입니다.
이에 대해 알아보겠습니다.

## 데이타에 대해 {#TheophData}

R에는 theophylline과 Indomethacin의 약동학 데이터가 내장되어 있습니다.

- `Theoph`: theophylline의 약동학 데이터, 12명, 320mg PO 단회투여, 0~24시간 채혈, NONMEM 의 run 폴더의 THEOPP 데이터와 동일합니다.
- `Indometh`: Indomethacin의 약동학 데이터, 6명, 25mg IV bolus 단회투여, 0~8시간 채혈(0, 0.25, 0.5, 0.75, 1, 1.25, 2, 3, 4, 5, 6, 8 h)
(데이터명의 첫글짜가 대문자임에 주의하길)

먼저 데이터를 살펴보겠습니다. 

```{r}
head(Theoph)
tail(Theoph)
```

다음과 같이 테스트 할 수 있습니다.

```{r}
TheophNca <- tblNCA(Theoph, key="Subject", dose=320, concUnit="mg/L")
```

이는 문자(character)로 구성된 matrix로 구성된 결과물과 단위 정보가 담긴 attribute를 포함하고 있습니다.

데이터가 Subject, weight, Dose, Time, Concentration 으로 구성되었음을 알 수 있습니다.

```{r TheophFig, fig.width=8, fig.height=12, fig.cap='Theoph 데이타를 시각화. A) Individual concentration-time curves, B) linear concentration-time curves, C) semi-logarithmic concentration-time curves'}
Backbone <- ggplot(Theoph %>% 
                       mutate(Subject = as.numeric(Subject)), 
                   aes(Time, conc, group = Subject, colour = Wt)) +
    geom_line() +
    geom_point() 

Individual <- Backbone + facet_wrap(~ Subject) + scale_y_log10()
groupLinear <- Backbone
groupLog <- groupLinear + scale_y_log10()

ggdraw() +
    draw_plot(Individual, 0, .5, 1, .5) +
    draw_plot(groupLinear, 0, 0, .5, .5) +
    draw_plot(groupLog, .5, 0, .5, .5) +
    draw_plot_label(c("A", "B", "C"), c(0, 0, 0.5), c(1, 0.5, 0.5), size = 15)
```

이 패키지로 NCA 비구획방법으로 약동학 파라미터를 산출하기 위해서는 아래와 같이 하면 됩니다.
우선 Theophilline 의 약동학 파라미터를 구해보면,

```{r}
NonCompart::tabNCA(Theoph, "Subject", "Time", "conc", dose=320)
```

다음으로 Indomethacin 의 약동학 파라미터를 구해보자. 이는 IV bolus 이므로 AdmMode 옵션이 추가된다.

```{r}
NonCompart::tabNCA(Indometh, "Subject", "time", "conc", dose=25, adm="Bolus", dur=0.5, concUnit="mg/L")
```

## NonCompart 사용법

NCA의 사용법은 다음과 같습니다.

`NCA(Data, colSubj, colTime, colConc, colTrt, Method = "Linear", Dose = 0, AdmMode = "Extravascular", TimeInfusion = 0, Report = "Table", iAUC)`

Data는 데이터셋을 설정하며, colSubj는 subject ID의 컬럼명, colTime은 time의 컬럼명, colConc는 concentration의 컬럼명, colTrT는 treatment code의 컬럼명(교차시험에서 사용)이다.

```{r, eval = FALSE}
tabNCA(concData, colSubj = "Subject", colTime = "Time", colConc = "conc", dose = 0, 
       adm = "Extravascular", dur = 0, doseUnit = "mg", timeUnit = "h", 
       concUnit = "ug/L", down = "Linear", MW = 0, returnNA = FALSE)
```

```{r, eval = FALSE, include = FALSE}
tblNCA(concData, key = "Subject", colTime = "Time", colConc = "conc", dose = 0, 
       adm = "Extravascular", dur = 0, doseUnit = "mg", timeUnit = "h", 
       concUnit = "ug/L", down = "Linear", MW = 0)
```

```{r}
args(NonCompart::tblNCA)
```

```{r, include = FALSE, evel = FALSE}
NonCompartdb <- tools::Rd_db('NonCompart')
tblNcaExample <- sapply(NonCompartdb, tools:::.Rd_get_metadata, 'usage')$tblNCA.Rd %>% .[-1]
paste(tblNcaExample, collapse = '\\n')
```



NCA의 옵션들에 대해서 간단히 살펴보자면 다음과 같다. 

1. Method
    - AUC와 AUMC를 구하는 trapezoidal method 설정, 기본값은 Method="Linear"
    - Linear와 Log 중 선택 가능하다.
    - Linear는 Linear trapezoidal method이며, Log는 Linear-up and log-down method 입니다.
2. Dose
    - 투여량에 대한 설정이다. 단위에 주의해야 한다. 벡터값을 줌으로서 각 대상자별 용량을 다르게 할 수 있습니다.
3. AdmMode
    - 투여경로에 대한 설정, 기본값은 AdmMode= "Extravascular" 
    - Bolus, Infusion, Extravascular 중에서 선택 가능하다.
4. TimeInfusion
    - 주입하는 기간(infusion duration)을 설정한다. 기본값은 0이다.
5. iAUC
    - 일부구간에 대한 AUC를 구하기 위한 구간설정 옵션입니다.
    - "Name", "Start", "End" 3개의 컬럼으로 구성된 데이터 프레임으로 설정해야 합니다.

일부 구간의 AUC를 구하는 방법은 조금 더 복잡하므로 자세히 알아보자.
예를 들어 0~12시간까지의 AUC, 0~24시간까지의 AUC를 구하고자 한다면 다음과 같이 하면 된다.
먼저 구하고자 하는 구간에 대한 정보를 갖는 변수를 아래와같이 생성한다.

```{r}
iAUC = data.frame(Name=c("AUC[0-12h]","AUC[0-24h]"), Start=c(0,0), End=c(12,24)) ; iAUC
```
        Name Start End
1 AUC[0-12h]     0  12
2 AUC[0-24h]     0  24

이제 iAUC 옵션을 이용해서 이를 구한다.

```{r}
# tabNCA(Theoph, "Subject", "Time", "conc", dose=320, iAUC=iAUC)
```

   Subject  CMAX      CMAXD TMAX TLAG CLST     CLSTP  TLST    LAMZHL       LAMZ LAMZLL LAMZUL LAMZNPT     CORRXY        R2     R2ADJ
1        1 10.50 0.03281250 1.12    0 3.28 3.2801465 24.37 14.304378 0.04845700   9.05  24.37       3 -0.9999999 0.9999997 0.9999995
2        2  8.33 0.02603125 1.92    0 0.90 0.8886398 24.30  6.659342 0.10408644   7.03  24.30       4 -0.9985967 0.9971954 0.9957931
3        3  8.20 0.02562500 1.02    0 1.05 1.0550967 24.17  6.766087 0.10244431   9.00  24.17       3 -0.9996624 0.9993250 0.9986499
4        4  8.60 0.02687500 1.07    0 1.15 1.1564216 24.65  6.981247 0.09928702   9.02  24.65       3 -0.9994619 0.9989241 0.9978483
5        5 11.40 0.03562500 1.00    0 1.57 1.5556951 24.35  8.002264 0.08661888   7.02  24.35       4 -0.9993234 0.9986472 0.9979708
6        6  6.44 0.02012500 1.15    0 0.92 0.9412712 23.85  7.894998 0.08779574   2.03  23.85       7 -0.9991203 0.9982413 0.9978896
7        7  7.09 0.02215625 3.48    0 1.15 1.1607192 24.22  7.846668 0.08833650   6.98  24.22       4 -0.9993349 0.9986702 0.9980053
8        8  7.56 0.02362500 2.02    0 1.25 1.2285268 24.12  8.510038 0.08145054   3.53  24.12       6 -0.9954961 0.9910124 0.9887655
9        9  9.03 0.02821875 0.63    0 1.12 1.1164831 24.43  8.405999 0.08245863   8.80  24.43       3 -0.9997218 0.9994437 0.9988873
10      10 10.21 0.03190625 3.55    0 2.42 2.4136923 23.70  9.246916 0.07495982   9.38  23.70       3 -0.9997543 0.9995087 0.9990174
11      11  8.00 0.02500000 0.98    0 0.86 0.8598066 24.08  7.261237 0.09545856   9.03  24.08       3 -0.9999991 0.9999983 0.9999965
12      12  9.75 0.03046875 3.52    0 1.17 1.1755390 24.15  6.286508 0.11025949   9.03  24.15       3 -0.9996984 0.9993968 0.9987936
      AUCLST    AUCALL    AUCIFO   AUCIFOD    AUCPEO    AUCIFP   AUCIFPD    AUCPEP   AUMCLST   AUMCIFO  AUMCPEO   AUMCIFP  AUMCPEP
1  148.92305 148.92305 216.61193 0.6769123 31.248917 216.61496 0.6769217 31.249876 1459.0711 4505.5348 67.61603 4505.6709 67.61701
2   91.52680  91.52680 100.17346 0.3130421  8.631687 100.06432 0.3127010  8.532030  706.5866  999.7723 29.32525  996.0716 29.06267
3   99.28650  99.28650 109.53597 0.3422999  9.357173 109.58572 0.3424554  9.398325  803.1859 1150.9648 30.21629 1152.6529 30.31850
4  106.79630 106.79630 118.37888 0.3699340  9.784331 118.44356 0.3701361  9.833594  901.0842 1303.2524 30.85881 1305.4981 30.97775
5  121.29440 121.29440 139.41978 0.4356868 13.000579 139.25463 0.4351707 12.897403 1017.1143 1667.7216 39.01174 1661.7937 38.79419
6   73.77555  73.77555  84.25442 0.2632951 12.437174  84.49670 0.2640522 12.688246  609.1524  978.4285 37.74176  986.9665 38.28034
7   90.75340  90.75340 103.77180 0.3242869 12.545221 103.89315 0.3246661 12.647366  782.4199 1245.0984 37.16000 1249.4111 37.37691
8   88.55995  88.55995 103.90669 0.3247084 14.769730 103.64305 0.3238845 14.552931  739.5346 1298.1158 43.03015 1288.5201 42.60589
9   86.32615  86.32615  99.90872 0.3122147 13.594978  99.86607 0.3120815 13.558076  705.2296 1201.7715 41.31750 1200.2124 41.24126
10 138.36810 138.36810 170.65206 0.5332877 18.918002 170.56791 0.5330247 18.878001 1278.1800 2473.9934 48.33535 2470.8765 48.27018
11  80.09360  80.09360  89.10274 0.2784461 10.110962  89.10072 0.2784397 10.108918  617.2422  928.5600 33.52694  928.4900 33.52193
12 119.97750 119.97750 130.58883 0.4080901  8.125757 130.63907 0.4082471  8.161087  977.8807 1330.3840 26.49636 1332.0528 26.58844
   MRTEVLST  MRTEVIFO  MRTEVIFP     VZFO     VZFP     CLFO     CLFP AUC[0-12h] AUC[0-24h]
1  9.797483 20.800031 20.800368 30.48675 30.48632 1.477296 1.477276   91.73552  147.69459
2  7.719996  9.980411  9.954313 30.69044 30.72392 3.194459 3.197943   67.48030   91.24908
3  8.089578 10.507642 10.518276 28.51710 28.50415 2.921415 2.920088   70.17971   99.10481
4  8.437410 11.009163 11.022112 27.22596 27.21110 2.703185 2.701709   73.05115  105.99811
5  8.385501 11.961873 11.933490 26.49799 26.52942 2.295227 2.297949   84.61490  120.73101
6  8.256833 11.612785 11.680533 43.25973 43.13569 3.798020 3.787130   51.75887   73.91422
7  8.621383 11.998427 12.025924 34.90844 34.86767 3.083689 3.080088   62.09875   90.49567
8  8.350666 12.493092 12.432287 37.81051 37.90669 3.079686 3.087520   62.71486   88.40890
9  8.169363 12.028695 12.018220 38.84279 38.85938 3.202924 3.204292   60.12123   85.82985
10 9.237534 14.497296 14.486174 25.01554 25.02788 1.875160 1.876086   90.81742  139.08507
11 7.706511 10.421227 10.420679 37.62219 37.62304 3.591360 3.591441   58.53963   80.02431
12 8.150534 10.187579 10.196436 22.22429 22.21575 2.450439 2.449497   85.02136  119.79884

맨 마지막 파라미터로 AUC[0-12h], AUC[0-24h]가 추가되었음을 알 수 있다.



## 함수 살펴보기

```r


AUC = function(x, y, down="Linear")
{
# Author: Kyun-Seop Bae k@acr.kr
# Last modification; 2017-07-24
# Called by: sNCA
# Calls: UT
# INPUT
#    x: time or similar vector
#    y: concentration or similar vector

  n = length(x)
# RETURNS
  Result = c(AUC = rep(NA_real_, n),   # vector of cumulative AUC
             AUMC = rep(NA_real_, n))  # vector of cumulative AUMC
# Input check
  if (n != length(y) | !is.numeric(x) | !is.numeric(y)) return(Result)

#
  Res = matrix(nrow=n, ncol=2) # temporary result
  Res[1,] = c(0, 0)
  for (i in 2:n) {
    if (y[i] >= y[i - 1]) { # if upward
      Res[i,1] = (x[i] - x[i-1])*(y[i] + y[i-1])/2
      Res[i,2] = (x[i] - x[i-1])*(x[i]*y[i] + x[i-1]*y[i-1])/2
    } else if (UT(down) == "LINEAR") { # downward & linear
      Res[i,1] = (x[i] - x[i-1])*(y[i] + y[i-1])/2
      Res[i,2] = (x[i] - x[i-1])*(x[i]*y[i] + x[i-1]*y[i-1])/2
    } else if (UT(down) == "LOG") { # downward & log
      k = (log(y[i - 1]) - log(y[i]))/(x[i] - x[i-1]) # -k slope in y-log scale
      Res[i,1] = (y[i-1] - y[i])/k
      Res[i,2] = (x[i-1]*y[i-1] - x[i]*y[i])/k + (y[i-1] - y[i])/k/k
    } else {
      Res[i,1] = NA_real_
      Res[i,2] = NA_real_
    }
  }
  Result = cbind(AUC=cumsum(Res[,1]), AUMC=cumsum(Res[,2]))
  return(Result)
}
```
