# How to use NonCompart 

[출처] NonCompart 사용법|작성자 김민걸 선생님 자료를 옮겨와서 변형합니다.

아산병원 배균섭 교수님께서 만드신 NonCompart 패키지 사용법에 대해서 간략히 적어봅니다. 뭐 별로 복잡한 것은 아니지만, R 초심자들을 위해 설치단계부터...
(참고로 첫칸의 > 기호는 R에서 프롬프트 이므로 이는 타이핑하지 않는다.)

우선 R을 설치한다. R은 아래 링크에서 다운로드 받을 수 있다.
https://cloud.r-project.org/

R을 실행한 후, 아래와 같이 패키지를 설치한다.  

```r
install.packages("NonCompart")
```

이제 아래와 같이 입력하여 패키지를 불러오자.

```r
library(NonCompart)
```

R에는 theophylline과 Indomethacin의 약동학 데이터가 내장되어 있다. 
Theoph: theophylline의 약동학 데이터, 12명, 320mg PO 단회투여, 0~24시간 채혈, NONMEM 의 run 폴더의 THEOPP 데이터와 동일
Indometh: Indomethacin의 약동학 데이터, 6명, 25mg IV bolus 단회투여, 0~8시간 채혈(0, 0.25, 0.5, 0.75, 1, 1.25, 2, 3, 4, 5, 6, 8 h)
(데이터명의 첫글짜가 대문자임에 주의하길)

데이터를 살펴보자. 

```{r}
head(Theoph)
```

데이터가 Subject, weight, Dose, Time, Concentration 으로 구성되었음을 알 수 있다.

이 패키지로 NCA 비구획방법으로 약동학 파라미터를 산출하기 위해서는 아래와 같이 하면 된다.  
우선 Theophilline 의 약동학 파라미터를 구해보면,

```{r}
NonCompart::tabNCA(Theoph, "Subject", "Time", "conc", dose=320)
```

다음으로 Indomethacin 의 약동학 파라미터를 구해보자. 이는 IV bolus 이므로 AdmMode 옵션이 추가된다.

```{r}
NonCompart::tabNCA(Indometh, "Subject", "time", "conc", dose=25, adm="Bolus", dur=0.5, concUnit="mg/L")
```

NCA의 사용법은 다음과 같다.
NCA(Data, colSubj, colTime, colConc, colTrt, Method = "Linear", Dose = 0, AdmMode = "Extravascular", TimeInfusion = 0, Report = "Table", iAUC)
Data는 데이터셋을 설정하며. colSubj는 subject ID의 컬럼명, colTime은 time의 컬럼명, colConc는 concentration의 컬럼명, colTrT는 treatment code의 컬럼명(교차시험에서 사용)이다.


```{r, eval = FALSE}
tabNCA(concData, colSubj = "Subject", colTime = "Time", colConc = "conc", dose = 0, 
       adm = "Extravascular", dur = 0, doseUnit = "mg", timeUnit = "h", 
       concUnit = "ug/L", down = "Linear", MW = 0, returnNA = FALSE)
```

NCA의 옵션들에 대해서 간단히 살펴보자면 다음과 같다. 

1. Method
    - AUC와 AUMC를 구하는 trapezoidal method 설정, 기본값은 Method="Linear"
    - Linear와 Log 중 선택 가능하다.
    - Linear는 Linear trapezoidal method이며, Log는 Linear-up and log-down method 이다.
2. Dose
    - 투여량에 대한 설정이다. 단위에 주의해야 한다. 벡터값을 줌으로서 각 대상자별 용량을 다르게 할 수 있다.
3. AdmMode
    - 투여경로에 대한 설정, 기본값은 AdmMode= "Extravascular" 
    - Bolus, Infusion, Extravascular 중에서 선택 가능하다.
4. TimeInfusion
    - 주입하는 기간(infusion duration)을 설정한다. 기본값은 0이다.
5. Report
    - 출력물의 형태. 기본값은 Report="Table" 이다.
    - Table, Text 증에서 선택 가능하다.
6. iAUC
    - 일부구간에 대한 AUC를 구하기 위한 구간설정 옵션이다.
    - "Name", "Start", "End" 3개의 컬럼으로 구성된 데이터 프레임으로 설정해야 한다.

일부 구간의 AUC를 구하는 방법은 조금 더 복잡하므로 자세히 알아보자.
예를 들어 0~12시간까지의 AUC, 0~24시간까지의 AUC를 구하고자 한다면 다음과 같이 하면 된다.
먼저 구하고자 하는 구간에 대한 정보를 갖는 변수를 아래와같이 생성한다.

```{r}
iAUC = data.frame(Name=c("AUC[0-12h]","AUC[0-24h]"), Start=c(0,0), End=c(12,24)) ; iAUC
```
        Name Start End
1 AUC[0-12h]     0  12
2 AUC[0-24h]     0  24

이제 iAUC 옵션을 이용해서 이를 구한다.

```{r}
# tabNCA(Theoph, "Subject", "Time", "conc", dose=320, iAUC=iAUC)
```

   Subject  CMAX      CMAXD TMAX TLAG CLST     CLSTP  TLST    LAMZHL       LAMZ LAMZLL LAMZUL LAMZNPT     CORRXY        R2     R2ADJ
1        1 10.50 0.03281250 1.12    0 3.28 3.2801465 24.37 14.304378 0.04845700   9.05  24.37       3 -0.9999999 0.9999997 0.9999995
2        2  8.33 0.02603125 1.92    0 0.90 0.8886398 24.30  6.659342 0.10408644   7.03  24.30       4 -0.9985967 0.9971954 0.9957931
3        3  8.20 0.02562500 1.02    0 1.05 1.0550967 24.17  6.766087 0.10244431   9.00  24.17       3 -0.9996624 0.9993250 0.9986499
4        4  8.60 0.02687500 1.07    0 1.15 1.1564216 24.65  6.981247 0.09928702   9.02  24.65       3 -0.9994619 0.9989241 0.9978483
5        5 11.40 0.03562500 1.00    0 1.57 1.5556951 24.35  8.002264 0.08661888   7.02  24.35       4 -0.9993234 0.9986472 0.9979708
6        6  6.44 0.02012500 1.15    0 0.92 0.9412712 23.85  7.894998 0.08779574   2.03  23.85       7 -0.9991203 0.9982413 0.9978896
7        7  7.09 0.02215625 3.48    0 1.15 1.1607192 24.22  7.846668 0.08833650   6.98  24.22       4 -0.9993349 0.9986702 0.9980053
8        8  7.56 0.02362500 2.02    0 1.25 1.2285268 24.12  8.510038 0.08145054   3.53  24.12       6 -0.9954961 0.9910124 0.9887655
9        9  9.03 0.02821875 0.63    0 1.12 1.1164831 24.43  8.405999 0.08245863   8.80  24.43       3 -0.9997218 0.9994437 0.9988873
10      10 10.21 0.03190625 3.55    0 2.42 2.4136923 23.70  9.246916 0.07495982   9.38  23.70       3 -0.9997543 0.9995087 0.9990174
11      11  8.00 0.02500000 0.98    0 0.86 0.8598066 24.08  7.261237 0.09545856   9.03  24.08       3 -0.9999991 0.9999983 0.9999965
12      12  9.75 0.03046875 3.52    0 1.17 1.1755390 24.15  6.286508 0.11025949   9.03  24.15       3 -0.9996984 0.9993968 0.9987936
      AUCLST    AUCALL    AUCIFO   AUCIFOD    AUCPEO    AUCIFP   AUCIFPD    AUCPEP   AUMCLST   AUMCIFO  AUMCPEO   AUMCIFP  AUMCPEP
1  148.92305 148.92305 216.61193 0.6769123 31.248917 216.61496 0.6769217 31.249876 1459.0711 4505.5348 67.61603 4505.6709 67.61701
2   91.52680  91.52680 100.17346 0.3130421  8.631687 100.06432 0.3127010  8.532030  706.5866  999.7723 29.32525  996.0716 29.06267
3   99.28650  99.28650 109.53597 0.3422999  9.357173 109.58572 0.3424554  9.398325  803.1859 1150.9648 30.21629 1152.6529 30.31850
4  106.79630 106.79630 118.37888 0.3699340  9.784331 118.44356 0.3701361  9.833594  901.0842 1303.2524 30.85881 1305.4981 30.97775
5  121.29440 121.29440 139.41978 0.4356868 13.000579 139.25463 0.4351707 12.897403 1017.1143 1667.7216 39.01174 1661.7937 38.79419
6   73.77555  73.77555  84.25442 0.2632951 12.437174  84.49670 0.2640522 12.688246  609.1524  978.4285 37.74176  986.9665 38.28034
7   90.75340  90.75340 103.77180 0.3242869 12.545221 103.89315 0.3246661 12.647366  782.4199 1245.0984 37.16000 1249.4111 37.37691
8   88.55995  88.55995 103.90669 0.3247084 14.769730 103.64305 0.3238845 14.552931  739.5346 1298.1158 43.03015 1288.5201 42.60589
9   86.32615  86.32615  99.90872 0.3122147 13.594978  99.86607 0.3120815 13.558076  705.2296 1201.7715 41.31750 1200.2124 41.24126
10 138.36810 138.36810 170.65206 0.5332877 18.918002 170.56791 0.5330247 18.878001 1278.1800 2473.9934 48.33535 2470.8765 48.27018
11  80.09360  80.09360  89.10274 0.2784461 10.110962  89.10072 0.2784397 10.108918  617.2422  928.5600 33.52694  928.4900 33.52193
12 119.97750 119.97750 130.58883 0.4080901  8.125757 130.63907 0.4082471  8.161087  977.8807 1330.3840 26.49636 1332.0528 26.58844
   MRTEVLST  MRTEVIFO  MRTEVIFP     VZFO     VZFP     CLFO     CLFP AUC[0-12h] AUC[0-24h]
1  9.797483 20.800031 20.800368 30.48675 30.48632 1.477296 1.477276   91.73552  147.69459
2  7.719996  9.980411  9.954313 30.69044 30.72392 3.194459 3.197943   67.48030   91.24908
3  8.089578 10.507642 10.518276 28.51710 28.50415 2.921415 2.920088   70.17971   99.10481
4  8.437410 11.009163 11.022112 27.22596 27.21110 2.703185 2.701709   73.05115  105.99811
5  8.385501 11.961873 11.933490 26.49799 26.52942 2.295227 2.297949   84.61490  120.73101
6  8.256833 11.612785 11.680533 43.25973 43.13569 3.798020 3.787130   51.75887   73.91422
7  8.621383 11.998427 12.025924 34.90844 34.86767 3.083689 3.080088   62.09875   90.49567
8  8.350666 12.493092 12.432287 37.81051 37.90669 3.079686 3.087520   62.71486   88.40890
9  8.169363 12.028695 12.018220 38.84279 38.85938 3.202924 3.204292   60.12123   85.82985
10 9.237534 14.497296 14.486174 25.01554 25.02788 1.875160 1.876086   90.81742  139.08507
11 7.706511 10.421227 10.420679 37.62219 37.62304 3.591360 3.591441   58.53963   80.02431
12 8.150534 10.187579 10.196436 22.22429 22.21575 2.450439 2.449497   85.02136  119.79884

맨 마지막 파라미터로 AUC[0-12h], AUC[0-24h]가 추가되었음을 알 수 있다.

약동학 파라이터를 보고서 형식의 text 파일로 저장해보자.
우선 자장될 폴더를 확인해면,

```{r}
getwd()
```

저장될 폴더를 변경하고자 한다면 setwd("저장될 경로") 이렇게 설정하면 된다.
위에서 사용한 NCA 명령어에 Report="Text" 라는 옵션을 추가하면 된다.
먼저, Theophilline 자료의 약동학 파라미터 분석 결과는 아래와 같이 텍스트파일로 저장할 수 있다.

```{r}
#writeLines(NCA(Theoph, "Subject", "Time", "conc", Dose=320, Report="Text"), "Theoph_Linear_CoreOutput.txt")
```

저장된 파일 내용은 아래와 같다.
NCA REPORT
Subject=1

                        NONCOMPARTMENTAL ANALYSIS REPORT
                       Package version 0.2.6 (2017-01-01)
                          R version 3.3.3 (2017-03-06)

Date and Time: 2017-03-11 20:46:33 KST

Calculation Setting
-------------------
Drug Administration: Extravascular
Observation count excluding trailing zero: 11
Dose at time 0: 320
AUC Calculation method: Linear-up Linear-down method
Weighting for lambda z: Uniform (Ordinary Least Square, OLS)
Lambda z selection criterion: Heighest adjusted R-squared value with precision=1e-4


Fitting, AUC, AUMC Result
-------------------------
      Time         Conc.      Pred.   Residual       AUC       AUMC      Weight
-------------------------------------------------------------------------------
     0.0000       0.7400                           0.0000     0.0000            
     0.2500       2.8400                           0.4475     0.0888            
     0.5700       6.5700                           1.9531     0.8015            
     1.1200      10.5000                           6.6474     5.0654            
     2.0200       9.6600                          15.7194    19.1383            
     3.8200       8.5800                          32.1354    66.1982            
     5.1000       8.3600                          42.9769   114.4617            
     7.0300       7.4700                          58.2529   206.2815            
     9.0500 *     6.8900     6.8912 -1.228e-03    72.7565   322.2988     1.0000
    12.1200 *     5.9400     5.9387 +1.324e-03    92.4505   528.5219     1.0000
    24.3700 *     3.2800     3.2801 -1.465e-04   148.9231  1459.0711     1.0000

\*: Used for the calculation of Lambda z.


Calculated Values
-----------------
CMAX       Max Conc                                       10.5000
CMAXD      Max Conc Norm by Dose                           0.0328
TMAX       Time of CMAX                                    1.1200
TLAG       Time Until First Nonzero Conc                   0.0000
CLST       Last Nonzero Conc                               3.2800
... 

개인별 약동학 파라미터를 구하려면 아래와 같이 할 수 있다.
IndiNCA를 사용하면 되며, NCA와의 차이점은 데이터셋과 subject 설정이 빠진다는 점이다.

> IndiNCA(Theoph[Theoph$Subject==1,"Time"], Theoph[Theoph$Subject==1, "conc"], Dose=320)
        CMAX        CMAXD         TMAX         TLAG         CLST        CLSTP         TLST       LAMZHL         LAMZ 
  10.5000000    0.0328125    1.1200000    0.0000000    3.2800000    3.2801465   24.3700000   14.3043776    0.0484570 
      LAMZLL       LAMZUL      LAMZNPT       CORRXY           R2        R2ADJ       AUCLST       AUCALL       AUCIFO 
   9.0500000   24.3700000    3.0000000   -0.9999999    0.9999997    0.9999995  148.9230500  148.9230500  216.6119330 
     AUCIFOD       AUCPEO       AUCIFP      AUCIFPD       AUCPEP      AUMCLST      AUMCIFO      AUMCPEO      AUMCIFP 
   0.6769123   31.2489169  216.6149558    0.6769217   31.2498763 1459.0711035 4505.5348194   67.6160287 4505.6708646 
     AUMCPEP     MRTEVLST     MRTEVIFO     MRTEVIFP         VZFO         VZFP         CLFO         CLFP 
  67.6170065    9.7974834   20.8000305   20.8003683   30.4867482   30.4863228    1.4772963    1.4772757 

개인별 약동학 파라미터를 보고서 형식의 text 파일로 저장해보자. 
Report 옵션을 추가하면 된다. Report="Text" 를 추가해보자.

> IndiNCA(Theoph[Theoph$Subject==1,"Time"], Theoph[Theoph$Subject==1, "conc"], Dose=320, Report="Text")
 [1] "                        NONCOMPARTMENTAL ANALYSIS REPORT"                           
 [2] "                       Package version 0.2.6 (2017-01-01)"                          
 [3] "                          R version 3.3.3 (2017-03-06)"                             
 [4] ""                                                                                   
 [5] "Date and Time: 2017-03-11 21:12:40 KST"                                             
 [6] ""                                                                                   
 [7] "Calculation Setting"                                                                
 [8] "-------------------"                                                                
 [9] "Drug Administration: Extravascular"                                                 
[10] "Observation count excluding trailing zero: 11"                                      
[11] "Dose at time 0: 320"                                                                
[12] "AUC Calculation method: Linear-up Linear-down method"                               
[13] "Weighting for lambda z: Uniform (Ordinary Least Square, OLS)"                       
[14] "Lambda z selection criterion: Heighest adjusted R-squared value with precision=1e-4"
[15] ""                                                                                   
[16] ""                                                                                   
[17] "Fitting, AUC, AUMC Result"                                                          
[18] "-------------------------"                                                          
[19] "      Time         Conc.      Pred.   Residual       AUC       AUMC      Weight"    
[20] "-------------------------------------------------------------------------------"    
[21] "     0.0000       0.7400                           0.0000     0.0000            "   
[22] "     0.2500       2.8400                           0.4475     0.0888            "   
[23] "     0.5700       6.5700                           1.9531     0.8015            "   
[24] "     1.1200      10.5000                           6.6474     5.0654            "   
[25] "     2.0200       9.6600                          15.7194    19.1383            "   
[26] "     3.8200       8.5800                          32.1354    66.1982            "   
[27] "     5.1000       8.3600                          42.9769   114.4617            "   
[28] "     7.0300       7.4700                          58.2529   206.2815            "   
[29] "     9.0500 *     6.8900     6.8912 -1.228e-03    72.7565   322.2988     1.0000"    
[30] "    12.1200 *     5.9400     5.9387 +1.324e-03    92.4505   528.5219     1.0000"    
[31] "    24.3700 *     3.2800     3.2801 -1.465e-04   148.9231  1459.0711     1.0000"    
[32] ""                                                                                   
[33] "*: Used for the calculation of Lambda z."                                           
[34] ""                                                                                   
[35] ""                                                                                   
[36] "Calculated Values"                                                                  
[37] "-----------------"                                                                  
[38] "CMAX       Max Conc                                       10.5000"                  
[39] "CMAXD      Max Conc Norm by Dose                           0.0328"                  
[40] "TMAX       Time of CMAX                                    1.1200"                  
[41] "TLAG       Time Until First Nonzero Conc                   0.0000"                  
[42] "CLST       Last Nonzero Conc                               3.2800"                  
[43] "CLSTP      Last Nonzero Conc Pred                          3.2801"                  
[44] "TLST       Time of Last Nonzero Conc                      24.3700"                  
[45] "LAMZHL     Half-Life Lambda z                             14.3044"                  
[46] "LAMZ       Lambda z                                        0.0485"                  
[47] "LAMZLL     Lambda z Lower Limit                            9.0500"                  
[48] "LAMZUL     Lambda z Upper Limit                           24.3700"                  
[49] "LAMZNPT    Number of Points for Lambda z                   3"                       
[50] "CORRXY     Correlation Between TimeX and Log ConcY        -1.0000"                  
[51] "R2         R Squared                                       1.0000"                  
[52] "R2ADJ      R Squared Adjusted                              1.0000"                  
[53] "AUCLST     AUC to Last Nonzero Conc                      148.9231"                  
[54] "AUCALL     AUC All                                       148.9231"                  
[55] "AUCIFO     AUC Infinity Obs                              216.6119"                  
[56] "AUCIFOD    AUC Infinity Obs Norm by Dose                   0.6769"                  
[57] "AUCPEO     AUC %Extrapolation Obs                         31.2489"                  
[58] "AUCIFP     AUC Infinity Pred                             216.6150"                  
[59] "AUCIFPD    AUC Infinity Pred Norm by Dose                  0.6769"                  
[60] "AUCPEP     AUC %Extrapolation Pred                        31.2499"                  
[61] "AUMCLST    AUMC to Last Nonzero Conc                    1459.0711"                  
[62] "AUMCIFO    AUMC Infinity Obs                            4505.5348"                  
[63] "AUMCPEO    AUMC %Extrapolation Obs                        67.6160"                  
[64] "AUMCIFP    AUMC Infinity Pred                           4505.6709"                  
[65] "AUMCPEP    AUMC % Extrapolation Pred                      67.6170"                  
[66] "MRTEVLST   MRT Extravasc to Last Nonzero Conc              9.7975"                  
[67] "MRTEVIFO   MRT Extravasc Infinity Obs                     20.8000"                  
[68] "MRTEVIFP   MRT Extravasc Infinity Pred                    20.8004"                  
[69] "VZFO       Vz Obs by F                                    30.4867"                  
[70] "VZFP       Vz Pred by F                                   30.4863"                  
[71] "CLFO       Total CL Obs by F                               1.4773"                  
[72] "CLFP       Total CL Pred by F                              1.4773"  

개인별 일부 구간의 AUC를 구하는 방법은 아래와 같다.
예를 들어 0~12시간까지의 AUC, 0~24시간까지의 AUC를 구하고자 한다면 다음과 같이 하면 된다.

> iAUC = data.frame(Name=c("AUC[0-12h]","AUC[0-24h]"), Start=c(0,0), End=c(12,24)) ; iAUC

        Name Start End
1 AUC[0-12h]     0  12
2 AUC[0-24h]     0  24


```{r eval = TRUE}
IntAUC
IntAUC(Theoph[Theoph$Subject==1,"Time"], Theoph[Theoph$Subject==1, "conc"], Dose=320, iAUC=iAUC)
```
        CMAX        CMAXD         TMAX         TLAG         CLST        CLSTP         TLST       LAMZHL         LAMZ 
  10.5000000    0.0328125    1.1200000    0.0000000    3.2800000    3.2801465   24.3700000   14.3043776    0.0484570 
      LAMZLL       LAMZUL      LAMZNPT       CORRXY           R2        R2ADJ       AUCLST       AUCALL       AUCIFO 
   9.0500000   24.3700000    3.0000000   -0.9999999    0.9999997    0.9999995  148.9230500  148.9230500  216.6119330 
     AUCIFOD       AUCPEO       AUCIFP      AUCIFPD       AUCPEP      AUMCLST      AUMCIFO      AUMCPEO      AUMCIFP 
   0.6769123   31.2489169  216.6149558    0.6769217   31.2498763 1459.0711035 4505.5348194   67.6160287 4505.6708646 
     AUMCPEP     MRTEVLST     MRTEVIFO     MRTEVIFP         VZFO         VZFP         CLFO         CLFP   AUC[0-12h] 
  67.6170065    9.7974834   20.8000305   20.8003683   30.4867482   30.4863228    1.4772963    1.4772757   91.7355220 
  AUC[0-24h] 
 147.6945866 

전반적으로 초보자도 어렵지 않게 사용할 수 있다.
역시 배균섭 교수님 이시다.
약동학 Plot 도 자동으로 그려주면 더 좋을텐데..ㅎㅎ


